\documentclass[11pt]{article}
\usepackage{natbib}
\begin{document}  
\input{macro}  %bring in ... the macro's    
%
%---------------------------------------------------------------
\newcommand{\dt}[1]{\partial_t{#1}}
\newcommand{\ddt}[1]{\partial^2_t{#1}}
\newcommand{\dddt}[1]{\partial^3_t{#1}}
\newcommand{\inv}[1]{\frac{1}{#1}}
\newcommand{\diff}[1]{D^+_{#1}}
\newcommand{\difb}[1]{D^-_{#1}}
%---------------------------------------------------------------
\title{PyEl2d - python library for visco-elastic modeling} 
       
\author{B.Arntsen}
\date{\today}
\maketitle
\tableofcontents
\clearpage
%=============================================================================
\section{Introduction} 
%=============================================================================
PyAc2d is a small and simple python library for Finit-Difference 
propagation of viscoelastic waves. The core of the library is 
capable of running on
multi-core cpu and also on gpu hardware.

In the following sections we outline the basic equations 
for visco-elastic waves in two and three dimensions.
It is followed by sections on the numerical implementation of 
the Finite-Difference
solution of viscoelastic wave propagation.
The PyAc2d python library is then described in detail, using several
examples. 
A separate section on the implementation details of 
the PyAc2d library is also given.

%==============================================================================
\section{The Viscoelastic equations of motion} 
%==============================================================================
In the following sections the viscoelastic equations are presented.
The only change from the standard case is that both the density and
the stress include relaxation.
%------------------------------------------------------------------------------
\subsection{The three dimensional case}
%------------------------------------------------------------------------------
The fundamental equation for viscoelastic wave propagation are written as
\begin{eqnarray}
  \ddt{u_i(\xx, t)} & = & \rho^{-1}(\xx,t)*\p_j \sigma_{ij}(\xx, t) 
                                               +f_i(\xx,t),     
					   \label{eq:ve-v}      \\
  \sigma_{ij}(\xx, t) & = & 
                    \lambda(\xx,t)* e_{kk}\delta_{ij} + 2\mu(\xx,t)* e_{ij} 
                                               +q_{ij}.          
					  \label{eq:ve-sigma}
\end{eqnarray}
$\xx=x,y,z$ denotes a spatial position with cartesioan components 
$x,y,z$ and $t$ is
the time.
$u_i$ is the $i$'th component of the particle
displacement and $i=x,y,z$. $\sigma_{i,j}$ is the stress tensor, while
$f_i$ is the $i$'th component of an external (source) body force. 
$q_{i,j}$ is an external (source) stress tensor.
$\rho$ is the density and $\lambda$ and $\mu$ are the Lam\'{e} parameters.
Note that both density and Lame\'{e} parameters are time dependent in order
to describe the effect of visco-elasticity.

Using the derivations in Appendix A the viscoelastic equations given
above in equations \eqref{eq:ve-v} and \eqref{eq:ve-sigma}
can be formulated as
\begin{eqnarray}
  \ddt{u_i(\xx, t)} 
              & = & \rho^{-1}_u(\xx)\p_j\sigma_{ij}+
                    \delta_{i,j}\chi_{p}(\xx,t)*\p_j 
                    \sigma_{ij}(\xx, t) + f_i(\xx,t)           \nonumber\\ 
              & + & (1-\delta_{i,j})\chi_{s}(\xx,t)*\p_j      
                    \sigma_{ij}(\xx,t),                         \\
					   \label{eq:v}
  \sigma_{ij}(\xx, t) & = & 
                    \lambda_u e_{kk}\delta_{ij} + 2\mu_u e_{ij} 
                                               +q_{ij}          \nonumber\\
                      & + & \delta_{ij}\phi_{\lambda}(t)*e_{ij} 
                                         +2\phi_{\mu}(t)*e_{ij}.
					  \label{eq:sigma}
\end{eqnarray}
Here $\rho_u$ is the elastic unrelaxed part of the density $\rho$, 
while $\lambda_u$ and $\mu_u$ are the corresponding unrelaxed part
of the Lam\'{e} parameters. The relaxation functions $\chi$ and $\phi$ contains
the effects of visco-elasticity and is equal to zero for a pure elastic medium.

Using the velocity $v_i = \dot{u}_i$, and writing out individual components one gets
\begin{eqnarray}
  \dt{v}_x & = & \rho^{-1}_u(\p_x \sigma_{xx} +\p_y \sigma_{xy} 
                                    +\p_z \sigma_{xz}) + f_x, \nonumber\\
            & = & + \chi_{p}*\p_x \sigma_{xx} 
                                    +\chi_{s}*(\p_y \sigma_{xy} 
                                    +\p_z \sigma_{xz}),       \nonumber\\
  \dt{v}_y & = & \rho^{-1}_u(p_x \sigma_{yx} +\p_y \sigma_{yy} 
                                    +\p_z \sigma_{yz}) + f_y, \nonumber\\
            & + & \chi_{p}*\p_x \sigma_{yx} 
                                    +\chi_{s}*(\p_y \sigma_{yy} 
                                    +\p_z \sigma_{yz})        \nonumber\\
  \dt{v}_z & = & \rho^{-1}_u\p_x \sigma_{zx} +\p_y \sigma_{zy} 
                                    +\p_z \sigma_{zz}) + f_z, \nonumber\\
            & + & \chi_{p}*\p_x \sigma_{zx} +\p_y \sigma_{zy} 
                                    +\chi_{s}*\p_y \sigma_{zz} 
                                    +\p_z \sigma_{zz}).
\end{eqnarray}

\begin{eqnarray}
  \dot{\sigma}_{xx} 
     & = & \lambda_u \left (\dot{e}_{xx} 
                 + \dot{e}_{yy} + \dot{e}_{zz}\right)
                 + 2\mu_u \dot{e}_{xx} +\dot{q}_{xx},          \nonumber\\ 
     & + & \phi_{\lambda}*[\dot{e}_{xx}+\dot{e}_{yy}
                 +\dot{e}_{zz}] + 2\phi_{\mu}(t)*\dot{e}_{xx}, \nonumber\\
  \dot{\sigma}_{yy} 
     & = & \lambda_u \left (\dot{e}_{xx} 
                 +\dot{e}_{yy} + \dot{e}_{zz}\right)
                 + 2\mu_u \dot{e}_{yy} +\dot{q}_{yy}           \nonumber\\
     & + & \phi_{\lambda}*[\dot{e}_{xx}+\dot{e}_{yy}
                 +\dot{e}_{zz}] + 2\phi_{\mu}(t)*\dot{e}_{yy}, \nonumber\\
  \dot{\sigma}_{zz} 
    & = & \lambda_u \left (\dot{e}_{xx} 
                + \dot{e}_{yy} + \dot{e}_{zz}\right)
                + 2\mu_u \dot{e}_{zz} +q_{zz},                 \nonumber\\
    & + & \phi_{\lambda}*[\dot{e}_{xx}
                +\dot{e}_{yy}+\dot{e}_{zz}] 
                + 2\phi_{\mu}(t)*\dot{e}_{zz},                 \nonumber\\
  \dot{\sigma}_{xy} 
   & = & 2\mu_u \dot{e}_{xy} +q_{xy} 
                + 2\phi_{\mu}(t)*\dot{e}_{xy},                 \nonumber\\
  \dot{\sigma}_{xz} 
   & = & 2\mu_u \dot{e}_{xz} +q_{xz} 
                + 2\phi_{\mu}(t)*\dot{e}_{xz},                 \nonumber\\
  \dot{\sigma}_{yz} 
   & = & 2\mu_u \dot{e}_{yz} +q_{yz}
               +  2\phi_{\mu}(t)*\dot{e}_{yz}.                 \nonumber\\
                                      \label{eq:ve-comp}
\end{eqnarray}

%=============================================================================
\subsubsection{Memory functions} 
%=============================================================================
We now define so-called memory variables by including the time 
convolution into one set of variables:
\begin{eqnarray}
 \gamma^l_{ij}(t) 
  & =& \delta_{i,j}\frac{1}{\Delta\lambda_l}\phi^l_{\lambda}*\dot{e}_{ij}  
    +  (1-\delta_{i,j})\frac{1}{\Delta\mu_l}\phi^l_{\mu}*\dot{e}_{ij}    \\  
 \theta^l_{kij}(t) 
  & =& \delta_{i,j}\frac{1}{\Delta\rho^p_l}
       \chi^l_{p}*\p_k\sigma_{ij} 
       +(1-\delta_{i,j})\frac{1}{\Delta\rho^p_l}
       \chi^l_{s}*\p_k\sigma_{ij} .  
\end{eqnarray}
Here 
\begin{eqnarray}
  \Delta\rho^{^{p}-1}_l 
     & = & \rho^{-1}_u\left(1-\frac{\upsilon^{p}_{\epsilon l}}
                           {\upsilon^{p}_{\sigma l}}\right),\nonumber \\
  \Delta\rho^{^{s}-1}_l 
     & = & \rho^{-1}_u\left(1-\frac{\upsilon^{s}_{\epsilon l}}
                           {\upsilon^{s}_{\sigma l}}\right),\nonumber \\
 \Delta\lambda_l                              
     & = & \lambda_u\left(1-\frac{\tau^{\lambda}_{\epsilon l}}
                           {\tau^{\lambda}_{\sigma l}}\right),  \nonumber \\
 \Delta\mu_l                              
     & = & \mu_u\left(1-\frac{\tau^{\mu}_{\epsilon l}}
                              {\tau^{\rho}_{\sigma l}}\right).    
\end{eqnarray}
Using equation \eqref{eq:phil}  for the $\phi$ and $\chi$ functions
give the the $\gamma$ and $\theta$ functions as:
\begin{eqnarray}
 \gamma^l_{ij}    
   & = & \delta_{i,j}\left[\frac{\exp(-t/\tau^{\lambda}_{\sigma l})}
                     {\tau^{\mu}_{\sigma l}
                     \sum_{l=1}^N \frac{\tau^{\lambda}_{\epsilon l}}
                     {\tau^{\mu}_{\sigma l}}}\right] 
                     *\dot{e}_{ij}    
    +  (1-\delta_{i,j})\left[\frac{\exp(-t/\tau^{\mu}_{\sigma l})}
                     {\tau^{\mu}_{\sigma l}
                     \sum_{l=1}^N \frac{\tau^{\mu}_{\epsilon l}}
                     {\tau^{\mu}_{\sigma l}}}\right] 
                     *\dot{e}_{ij},    
\end{eqnarray}
\begin{eqnarray}
 \theta^l_{kij}    
   & = & \delta_{i,j}\left[\frac{\exp(-t/\upsilon^{\lambda}_{\sigma l})}
                    {\upsilon^{\lambda}_{\sigma l}
                    \sum_{l=1}^N \frac{\upsilon^{\rho}_{\epsilon l}}
                    {\upsilon^{\rho}_{\sigma l}}}\right] 
                    *\p_k \sigma_{ij}
    +  (1-\delta_{i,j})\left[\frac{\exp(-t/\upsilon^{\mu}_{\sigma l})}
                    {\upsilon^{\rho}_{\sigma l}
                    \sum_{l=1}^N \frac{\upsilon^{\rho}_{\epsilon l}}
                    {\upsilon^{\rho}_{\sigma l}}}\right] 
                    *\p_k \sigma_{ij}.
\end{eqnarray}


This gives the final form of the viscoelastic equations
%
\begin{eqnarray}
  \dt{v}_x 
     & = & \rho^{-1}_i\left(\p_x \sigma_{xx} +\p_y 
           \sigma_{xy} +\p_z \sigma_{xz}\right) + f_x,       \nonumber\\
     & + & \sum_{l=0}^N\theta^l_{xxx}\Delta\rho^{-1}_{l} 
           +  \sum_{l=0}^N\theta^l_{yxy}\Delta\rho^{-1}_{l} 
           +  \sum_{l=0}^N\theta^l_{zxz}\Delta\rho^{-1}_{l}, \nonumber\\ 
  \dt{v}_y 
     & = & \p_x \sigma_{yx} +\p_y \sigma_{yy} +\p_z 
           \sigma_{yz} + f_y,                                \nonumber\\
     & + & \sum_{l=0}^N\theta^l_{xyx}\Delta\rho^{-1}_{l} 
           +  \sum_{l=0}^N\theta^l_{yyy}\Delta\rho^{-1}_{ll} 
           +  \sum_{l=0}^N\theta^l_{zyz}\Delta\rho^{-1}_{ll}.\nonumber\\ 
  \dt{v}_z 
    & = & \p_x \sigma_{zx} +\p_y \sigma_{zy} 
          +\p_z \sigma_{zz} + f_z,                           \nonumber\\
    & + & \sum_{l=0}^N\theta^l_{xzx} +  \sum_{l=0}^N\theta^l_{yzy} +  
          \sum_{l=0}^N\theta^l_{zzz}.                        \nonumber\\
\end{eqnarray}
\begin{eqnarray}
    \dot{e_{xx}} & = & \p_x v_x, \nonumber\\
    \dot{e_{yy}} & = & \p_y v_y, \nonumber\\
    \dot{e_{zz}} & = & \p_z v_z, \nonumber\\
    \dot{e_{xy}} & = & \frac{1}{2}(\p_x v_y + \p_y v_x),\nonumber\\
    \dot{e_{xz}} & = & \frac{1}{2}(\p_x v_z + \p_z v_y),\nonumber\\
    \dot{e_{yz}} & = & \frac{1}{2}(\p_y v_z + \p_z v_y).\nonumber\\
\end{eqnarray}
\begin{eqnarray}
  \dot{\sigma}_{xx} 
    & = & \lambda_u \left (\dot{e}_{xx} + \dot{e}_{yy} + \dot{e}_{zz}\right)
         + 2\mu_u \dot{e}_{xx} +\dot{q}_{xx}                 \nonumber\\
    & + & \sum_{l=1}^N\left[\gamma^l_{xx}+\gamma^l_{yy}
                           +\gamma^l_{zz}\right]\Delta\lambda_l
         + 2\sum_{l=1}^N\gamma^l_{xx}\Delta\mu_l,            \nonumber\\
  \dot{\sigma}_{yy} 
    & = & \lambda_u 
         \left (\dot{e}_{xx} + \dot{e}_{yy} + \dot{e}_{zz}\right)
         + 2\mu_u \dot{e}_{yy} +\dot{q}_{yy},                     \nonumber\\
    & + & \sum_{l=1}^N\left[\gamma^l_{xx}+\gamma^l_{yy} +
                             \gamma^l_{zz}\right] \Delta\lambda_l  
         + 2\sum_{l=1}^N\gamma^l_{yy}\Delta\mu_l,                 \nonumber\\
  \dot{\sigma}_{zz} 
    & = & \lambda_u \left (\dot{e}_{xx} + \dot{e}_{yy} 
         + \dot{e}_{zz}\right)+ 2\mu_u \dot{e}_{zz} +\dot{q}_{zz} \nonumber\\
    & + & \sum_{l=1}^N\left[\gamma^l_{xx}+\gamma^l_{yy}
                           +\gamma^l_{zz}\right]\Delta\lambda_l  
         + 2\sum_{l=1}^N\gamma_{zz}\Delta\mu_l,                   \nonumber\\
  \dot{\sigma}_{xy} 
    & = & 2\mu \dot{e}_{xy} + 2\sum_{l=1}^N\gamma^l_{xy}
          \Delta\mu_l+\dot{q}_{xy}                                \nonumber,\\
  \dot{\sigma}_{xz} 
    & = & 2\mu \dot{e}_{xz} + 2\sum_{l=1}^N\gamma^l_{xz}
          \Delta\mu_l+\dot{q}_{xz}                                \nonumber,\\
  \dot{\sigma}_{yz} 
    & = & 2\mu \dot{e}_{yz} + 2\sum_{l=1}^N\gamma^l_{yz}
          \Delta\mu_l+\dot{q}_{yz}                                \nonumber,\\
                 \label{eq:visco-el}
\end{eqnarray} 


%==============================================================================
\subsubsection{Integration of memory functions}
%==============================================================================
The memory functions  obeys approximately a recursive relation (See the
Appendix). As an example we consider $\gamma^l_{xx}$

\begin{eqnarray}
\gamma^l_{xx}(t) & = &
            \exp(-\frac{\Delta t}{\tau^{\lambda l}_{\sigma}})
              \gamma^l_{\lambda}(t-\Delta t)
            +\left(\frac{\Delta t}{\tau^{\lambda}_{\sigma l}
            \sum_{l=1}^N\frac{\tau^{\lambda}_{\epsilon l}}
                             {\tau^{\lambda}_{\sigma l}}}\right)
             \dot{e}_{xx}(t). 
\end{eqnarray}
%
The other components of $\gamma$ and $\theta$ obeys similar recursive
relations.
Defining the quantities
\begin{eqnarray}
\alpha^l_1 & = & \exp(-\frac{\Delta t}{\tau^{\lambda}_{\sigma l}}), \nonumber\\
\alpha^l_2 & = & \frac{\Delta t}{\tau^{\lambda}_{\sigma l}
                 \sum_{l=1}^N\frac{\tau^{\lambda}_{\epsilon l}}
                                  {\tau^{\lambda}_{\sigma l}}} ,
%\end{eqnarray}
%\beta^l_1  & = &\exp(-\frac{\Delta t}{\tau^{\mu}_{\sigma l}}) ,\\
%\beta^l_2  & = &\frac{\Delta t}{\tau^{\mu}_{\sigma l}\sum_{l=1}^N
%                \frac{\tau^{\mu}_{\epsilon l}}{\tau^{\mu}_{\sigma l}}},\\
%\eta^l_1  & = &\exp(-\frac{\Delta t}{\tau^{\rho}_{\sigma l}}) ,\\
%\eta^l_2  & = &\frac{\Delta t}{\tau^{\rho}_{\sigma l}\sum_{l=1}^N
%               \frac{\tau^{\rho}_{\epsilon l}}{\tau^{\rho}_{\sigma l}}} 
\end{eqnarray}

%
we get
\begin{eqnarray}
\gamma^l_{xx}(t)   = \alpha^l_1 \gamma^l_{xx}(t-\Delta t) 
                        + \alpha^l_2\dot{e}_{xx}(t).
\end{eqnarray}
%
For the other components we can write in a similar way:
\begin{eqnarray}
\gamma^l_{yy}(t)  & = &\alpha^l_1 \gamma^l_{yy}(t-\Delta t) 
                        + \alpha^l_2\dot{e}_{yy}(t-\Delta t),\nonumber\\
\gamma^l_{zz}(t)  & = &\alpha^l_1 \gamma^l_{zz}(t-\Delta t) 
                        + \alpha^l_2\dot{e}_{zz}(t-\Delta t),\nonumber\\
\gamma^l_{xy}(t)  & = &\beta^l_1 \gamma^l_{xy}(t-\Delta t) 
                        + \beta^l_2\dot{e}_{xy}(t-\Delta t), \nonumber\\
\gamma^l_{xz}(t)  & = &\beta^l_1 \gamma^l_{xz}(t-\Delta t) 
                        + \beta^l_2\dot{e}_{xz}(t-\Delta t), \nonumber\\
\gamma^l_{yz}(t)  & = &\beta^l_1 \gamma^l_{yz}(t-\Delta t) 
                        + \beta^l_2\dot{e}_{yz}(t-\Delta t) \nonumber\\
\end{eqnarray}

Here the $\beta$ coefficients are given by

\begin{eqnarray}
\beta^l_1  & = &\exp(-\frac{\Delta t}{\tau^{\mu}_{\sigma l}}) , \nonumber \\
\beta^l_2  & = &\frac{\Delta t}{\tau^{\mu}_{\sigma l}\sum_{l=1}^N
                                 \frac{\tau^{\mu}_{\epsilon l}}
                                  {\tau^{\mu}_{\sigma l}}}.
                                                                \nonumber\\
\end{eqnarray}

The theta relations are
\begin{eqnarray}
\theta^l_{xxx}(t)  & = &\eta^l_1 \theta^l_{xxx}(t-\Delta t) 
            + \eta^l_2\p_x\sigma_{xx}(t-\Delta t),  \nonumber \\
\theta^l_{yyy}(t)  & = &\eta^l_1 \theta^l_{yyy}(t-\Delta t) 
            + \eta^l_2\p_y\sigma_{yy}(t-\Delta t),  \nonumber \\
\theta^l_{zzz}(t)  & = &\eta^l_1 \theta^l_{zzz}(t-\Delta t) 
            + \eta^l_2\p_z\sigma_{zz}(t-\Delta t),  \nonumber \\
\theta^l_{yxy}(t)  & = &\nu^l_1 \theta^l_{yxy}(t-\Delta t) 
            + \nu^l_2\p_y\sigma_{xy}(t-\Delta t),  \nonumber \\
\theta^l_{zxz}(t)  & = &\nu^l_1 \theta^l_{zxz}(t-\Delta t) 
            + \nu^l_2\p_z\sigma_{xz}(t-\Delta t),  \nonumber \\
\theta^l_{xyx}(t)  & = &\nu^l_1 \theta^l_{xyx}(t-\Delta t) 
            + \nu^l_2\p_x\sigma_{yx}(t-\Delta t),  \nonumber \\
\theta^l_{zyz}(t)  & = &\nu^l_1 \theta^l_{zyz}(t-\Delta t) 
            + \nu^l_2\p_z\sigma_{yz}(t-\Delta t),  \nonumber \\
\theta^l_{xzx}(t)  & = &\nu^l_1 \theta^l_{xzx}(t-\Delta t) 
            + \nu^l_2\p_x\sigma_{zx}(t-\Delta t),  \nonumber \\
\theta^l_{yzy}(t)  & = &\nu^l_1 \theta^l_{yzy}(t-\Delta t) 
            + \nu^l_2\p_y\sigma_{zy}(t-\Delta t).  \nonumber \\
\end{eqnarray}

The $\eta$ and $\nu$ coefficients are given by

\begin{eqnarray}
\eta^l_1  & = &\exp(-\frac{\Delta t}{\tau^{p}_{\sigma l}}) , \nonumber \\
\eta^l_2  & = &\frac{\Delta t}{\tau^{p}_{\sigma l}\sum_{l=1}^N
                                 \frac{\tau^{p}_{\epsilon l}}
                                  {\tau^{p}_{\sigma l}}}, \nonumber \\
\nu^l_1  & = &\exp(-\frac{\Delta t}{\tau^{s}_{\sigma l}}) , \nonumber \\
\nu^l_2  & = &\frac{\Delta t}{\tau^{s}_{\sigma l}\sum_{l=1}^N
                           \frac{\tau^{s}_{\epsilon l}}
                            {\tau^{s}_{\sigma l}}}, \nonumber \\
\end{eqnarray}


%------------------------------------------------------------------------------
\subsection{The two dimensional case}
%------------------------------------------------------------------------------
In  two dimensions equation \ref{eq:ve-comp} reduces to:

\begin{eqnarray}
  \dot{v}_x & = & \rho^{-1}_u\left[\p_x \sigma_{xx} 
                  +\p_y \sigma_{xy}\right] + \dot{f}_x        \nonumber \\
            & + &  \chi_{p}*\p_x \sigma_{xx}  
                  +\chi_{s}*\p_y \sigma_{xy},               \nonumber \\
  \dot{v}_y & = & \rho^{-1}_u\left[\p_x \sigma_{xy} 
                  +\p_y \sigma_{yy}\right] + \dot{f}_y        \nonumber \\
            & + &  \chi_{p}*\p_y \sigma_{yy}  
                  +\chi_{s}*\p_x \sigma_{xy}.               
\end{eqnarray}

\begin{eqnarray}
  \dot{e}_{xx} & = & \p_x v_x,                                  \nonumber \\
  \dot{e}_{yy} & = & \p_y v_x,                                  \nonumber \\
  \dot{e}_{xy} & = & \frac{1}{2}\left[\p_x v_y+\p_y v_x\right].
\end{eqnarray}

\begin{eqnarray}
  \dot{\sigma}_{xx} 
     & = & \lambda_u \left [\dot{e}_{xx} 
                 + \dot{e}_{yy} \right]
                 + 2\mu_u \dot{e}_{xx} +\dot{q}_{xx}  \nonumber\\          
     & + & \phi_{\lambda}*[\dot{e}_{xx}+\dot{e}_{yy}]
                + 2\phi_{\mu}(t)*\dot{e}_{xy}         \nonumber\\ 
  \dot{\sigma}_{yy} 
     & = & \lambda_u \left (\dot{e}_{xx} 
                 +\dot{e}_{yy} + \right)
                 + 2\mu_u \dot{e}_{yy} +\dot{q}_{yy},           \nonumber\\
     & + & \phi_{\lambda}*[\dot{e}_{xx}+\dot{e}_{yy}]
                + 2\phi_{\mu}(t)*\dot{e}_{xy}                   \nonumber\\ 
  \dot{\sigma}_{xy} 
    & = & 2\mu_u \dot{e}_{xy} +q_{xy}.                          
\end{eqnarray}

The final form of the visco-elastic equations in two dimensions is then
\begin{eqnarray}
  \dt{v}_x 
     & = & \rho^{-1}\left(\p_x \sigma_{xx} +\p_y
           \sigma_{xy} \right) + \rho^{-1}f_x,       \nonumber\\
     & + & \sum_{l=0}^N\theta^l_{xxx}\Delta\rho^{-1}_{l} 
           +  \sum_{l=0}^N\theta^l_{yxy}\Delta\rho^{-1}_{l} 
           \nonumber\\ 
  \dt{v}_y 
     & = & \rho^{-1}\left(\p_x \sigma_{yx} +\p_y 
           \sigma_{yy}\right)  + \rho^{-1}f_y,                      \nonumber\\                 
     & + & \sum_{l=0}^N\theta^l_{xyx}\Delta\rho^{-1}_{l} 
           +  \sum_{l=0}^N\theta^l_{yyy}\Delta\rho^{-1}_{l} 
           .\nonumber\\ 
\end{eqnarray}

\begin{eqnarray}
    \dot{e_{xx}} & = & \p_x v_x, \nonumber\\
    \dot{e_{yy}} & = & \p_y v_y, \nonumber\\
    \dot{e_{zz}} & = & \p_z v_z, \nonumber\\
    \dot{e_{xy}} & = & \frac{1}{2}(\p_x v_y + \p_y v_x),\nonumber\\
\end{eqnarray}
\begin{eqnarray}
  \dot{\sigma}_{xx} 
    & = & \lambda_u \left (\dot{e}_{xx} + \dot{e}_{yy} \right)
         + 2\mu_u \dot{e}_{xx}                                \nonumber\\
    & + & \sum_{l=1}^N\left[\gamma^l_{xx}
                           +\gamma^l_{yy}\right]\Delta\lambda_l
         + 2\sum_{l=1}^N\gamma^l_{xx}\Delta\mu_l,            \nonumber\\
  \dot{\sigma}_{yy} 
    & = & \lambda_u 
         \left (\dot{e}_{xx} + \dot{e}_{yy} \right)
         + 2\mu_u \dot{e}_{yy},                     \nonumber\\
    & + & \sum_{l=1}^N\left[\gamma^l_{xx}+\gamma^l_{yy} +
                             \right] \Delta\lambda_l  
         + 2\sum_{l=1}^N\gamma^l_{yy}\Delta\mu_l,                 \nonumber\\
  \dot{\sigma}_{xy} 
    & = & 2\mu \dot{e}_{xy} + 2\sum_{l=1}^N\gamma^l_{xy}
          \Delta\mu_l+\dot{q}_{xy}                                \nonumber,\\
\end{eqnarray} 

%============================================================================
\section{Numerical grids}
%=============================================================================
The equations given above can be solved numerically by using the 
Finite-Difference method. 
We first need to define the numerical grids involved.

%------------------------------------------------------
\subsection{Two dimensional case}
%------------------------------------------------------

We now consider a regular grid with positions $\xx$ 
defined as
\begin{eqnarray}
\xx & = & (x,y),\\
x   & = & p\Delta x,\\
y   & = & q\Delta y,\\
t   & = & n\Delta t.
\end{eqnarray}
where $p=0,1,2,\ldots,N_x$, $q=0,1,2,\ldots,N_y$ and
$N_x,N_y$ are the number of grid points in the $x$ and 
$y$-directions.
$n=0,1,2,\ldots,N_t$ where $N_t$ is the number of time steps.

We will also need a regular grid which is displaced, or staggered, 
relative to the the regular grid.
Sometimes we will refer to the regular grid as the reference grid.

The particle velocities  $v_x$ and $v_y$ are defined on grids
as follows
%
\begin{eqnarray}
  v_x(\xx, t) & = & v_x(x+\Delta x/2, y, t),\nonumber\\
  v_y(\xx, t) & = & v_y(x, y+\Delta y/2, t),\nonumber\\
\end{eqnarray}
%


The diagonal stresses are defined on the grids
\begin{eqnarray}
  \sigma_{xx}(\xx, t) & = & \sigma_{xx}( x,y,t), \nonumber\\
  \sigma_{yy}(\xx, t) & = & \sigma_{yy}(x, y,t), \nonumber\\
\end{eqnarray}
The off-diagonal stress 
%
\begin{eqnarray}
  \sigma_{xy}(\xx, t) & = & \sigma_{xy}(x +\Delta x/2, y+\Delta y/2t) 
                                        \nonumber\\
\end{eqnarray}

The Lam\'{e} parameters are defined on grids as follows:
as follows:
%
\begin{eqnarray}
   \lambda_u(\xx) & = & \lambda_u(x,y),\\
   \mu_u(\xx)     & = & \mu_u(x+\Delta x/2,y+\Delta y/2), \nonumber\\
   \mu_u(\xx)     & = & \mu_u(x,y).
\end{eqnarray}

The inverse density and $\mu$ are defined  on three different staggered grids as follows:
\begin{eqnarray}
   \rho_x^{-1}(\xx) & = & \rho^{-1}(x+\Delta x/2, y),       \nonumber\\
   \rho_y^{-1}(\xx) & = & \rho^{-1}(x,y+\Delta y/2).        \nonumber
\end{eqnarray}

The $\theta$ functions are defined on two different grids:
\begin{eqnarray}
   \theta_{xxx} & = & \theta(x+\Delta x/2),\\
   \theta_{yxy} & = & \theta(x+\Delta x/2),\\
   \theta_{xyx} & = & \theta(x,y+\Delta y/2),\\
   \theta_{yyy} & = & \theta(x,y+\Delta y/2).
\end{eqnarray}
The $gamma$ functions are defined on the grids
\begin{eqnarray}
   \gamma_{xx} & = & \gamma(x,y)\\
   \gamma_{yy} & = & \gamma(x,y)\\
   \gamma_{xy} & = & \gamma(x+\Delta x/2,y+\Delta y/2).
\end{eqnarray}

%=================================================================
\section{Finite-Difference Solution algorithms}
%=================================================================
We are now in a position to formulate a complete numerical 
solution of the visco-elastic equations.
Below we give full expressions for
solution algorithms in two dimensions, as well
as specialization to the visco-acoustic case.

Differentiation is now replaced by numerical approximations so 
that $\p_x$ and $\p_y$ 
are replaced with numerical operators $d^+_x,d^-_x,d^+_y,d^-_y$.
These operators connects the staggered and reference grids, and we 
illustrate this with the differentiation
in the x-direction.
The derivative of a function $a(x)$ is approximately given at 
$a(x+\Delta x/2)$and
at $a(x-\Delta x/2)$ by
\begin{eqnarray}
a'(x+\Delta x/2) & = & d^+_x a(x),\nonumber\\
a'(x-\Delta x/2) & = & d^-_x a(x).
\end{eqnarray}

The differentiators $d^+$ and $d^-$ are given by
\citep{Holberg1987}
%
\begin{eqnarray}
   \d^+ & = & \inv{\Delta x}\sum_{l=1}^L \alpha_l\left[u(x +l\Delta x) -
		          u(x - (l-1)\Delta x\right]\nonumber\\	
   \d^- & = & \inv{\Delta x}\sum_{l=1}^L \alpha_l\left[u(x +(l-1)\Delta x) -
					          u(x - l\Delta x)\right]
\end{eqnarray}
where the coefficients $\alpha_l$ are found through an optimization procedure.
Similar differentiators are defined for the $y$-direction and for 
the $z$-direction, with obvious names.

%-----------------------------------------
\subsection{The two dimensional case}
%-------------------------------------------
Using the numerical differentiators the equations of motion becomes:

\begin{eqnarray}
  \dot{v}_x & = & \rho^{-1}_x\left(d^+_x \sigma_{xx} +d^-_y \sigma_{xy}\right) 
             +   \rho^{-1}_x \dot{f}_x                             \nonumber\\ 
            & + & \sum_{l=0}^N\theta^l_{xxx}\Delta\rho^{-1}_{lx}
             +  \sum_{l=0}^N\theta^l_{yxy}\Delta\rho^{-1}_{lix}      \nonumber\\
  \dot{v}_y & = & \rho^{-1}_y\left(d^-_x \sigma_{xy} +d^+_y \sigma_{yy}\right) 
             +   \rho^{-1}_y \dot{f}_y.                            \nonumber\\
            & + & \sum_{l=0}^N\theta^l_{xyx}\Delta\rho^{-1}_{ly}
           +  \sum_{l=0}^N\theta^l_{yyy}\Delta\rho^{-1}_{ly}.        \nonumber \\
\end{eqnarray}
\begin{eqnarray}
    \dot{e}_{xx} & = & d^-_x v_x, \nonumber \\
    \dot{e}_{yy} & = & d^-_y v_y, \nonumber \\
    \dot{e}_{xy} & = & \frac{1}{2}(d^+_x v_y + d^+_y v_x),\nonumber\\
                \label{eq:strains}
    \dot{e}_{yx} & = & \frac{1}{2}(d^+_x v_y + d^+_y v_x),\nonumber\\
                \label{eq:strains}
\end{eqnarray}
\begin{eqnarray}
  \dot{\sigma}_{xx} 
     & = & \lambda_u \left [\dot{e}_{xx} 
                 + \dot{e}_{yy} \right]
                 + 2\mu_u \dot{e}_{xx} +\dot{q}_{xx},           \nonumber\\ 
    & + & \sum_{l=1}^N\left[\gamma^l_{xx}
                           +\gamma^l_{yy}\right]\Delta\lambda_l
         + 2\sum_{l=1}^N\gamma^l_{xx}\Delta\mu_l,                \nonumber\\
  \dot{\sigma}_{yy} 
     & = & \lambda_u \left (\dot{e}_{xx} 
                 +\dot{e}_{yy} + \right)
                 + 2\mu_u \dot{e}_{yy} +\dot{q}_{yy},           \nonumber\\
    & + & \sum_{l=1}^N\left[\gamma^l_{xx}
                           +\gamma^l_{yy}\right]\Delta\lambda_l
         + 2\sum_{l=1}^N\gamma^l_{yy}\Delta\mu_l,                \nonumber\\
  \dot{\sigma}_{xy} 
  &  = &   2\mu \dot{e}_{xy} + 2\sum_{l=1}^N\gamma^l_{xy}
          \Delta\mu_l+\dot{q}_{xy}.                              \nonumber\\
  \dot{\sigma}_{yx} 
  &  = &   2\mu \dot{e}_{yx} + 2\sum_{l=1}^N\gamma^l_{xy}
          \Delta\mu_l+\dot{q}_{xy}.                              \nonumber\\
\end{eqnarray}

The time derivatives is approximated by the central difference
\begin{eqnarray}
\dot{a}(t) = \frac{a(t+\Delta t/2) - a(t-\Delta t/2)}{\Delta t}
                      \label{eq:time-derivative}
\end{eqnarray}

We use the expression for the approximate time derivative given by 
equation \eqref{eq:time-derivative}
in equations \eqref{eq:visco-el} to obtain an expression for the 
components of the particle velocity
\begin{eqnarray}
v_x(t+\Delta t/2) 
      & = & \Delta t\rho_x^{-1}\left[d^+_x \sigma_{xx}(t) 
            +d^+_y \sigma_{xy}(t)\right] 
            + \Delta t \rho_x^{-1}f_x(t) +                    \nonumber\\ 
      & + & \Delta t\sum_{l=0}^N\theta^l_{xxx}(t)\Delta\rho^{-1}_{lx}
            + \Delta t\sum_{l=0}^N\theta^l_{yxy}(t)\Delta\rho^{-1}_{lx} 
            +v_x(t-\Delta t/2),\nonumber\\
v_y(t+\Delta t/2) & = &  \Delta t \rho_z^{-1}\left[
            d^+_x \sigma_{yx}(t) 
            +d^+_y \sigma_{yy}(t)\right] 
            +\Delta t \rho_y^{-1}f_y(t)\nonumber\\  
      & + & \Delta t\sum_{l=0}^N\theta^l_{yyy}(t)\Delta\rho^{-1}_{ly}
            +  \Delta t\sum_{l=0}^N\theta^l_{yxy}(t)\Delta\rho^{-1}_{ly} 
            +v_y(t-\Delta t/2),\nonumber\\
                       \label{eq:vi-2d}
\end{eqnarray}
The strains can now be computed from equation \eqref{eq:strains}
\begin{eqnarray}
  \dot{e}_{xx}(t+\Delta t/2) & = & d^-_x v_x(t+\Delta t/2),     \nonumber  \\
  \dot{e}_{zz}(t+\Delta t/2) & = & d^-_z v_z(t+\Delta t/2),     \nonumber  \\
  \dot{e}_{xz}(t+\Delta t/2) & = & \frac{1}{2}\left[d^+_x v_z(t+\Delta t/2) 
                             + d^+_z v_x(t+\Delta t/2)\right], \nonumber   \\
                       \label{eq:strain2d}
\end{eqnarray}
%
Equations \eqref{eq:stress}   can be solved for the stresses using 
the same approach as for the particle velocities:
\begin{eqnarray}
  \sigma_{xx}(t+\Delta t) & = & \Delta t\lambda_u 
                               \left [
                                  \dot{e}_{xx}(t+\Delta t/2)  + 
                                  \dot{e}_{zz}(t+\Delta t/2)
                               \right]\nonumber                              \\
                          & + & 2\Delta t\mu_u \dot{e}_{xx}(t+\Delta t/2) 
                                +\Delta t\dot{q}_{xx}               \nonumber\\
                          & + & \Delta t\sum_{l=1}^N
                                 \left[\gamma^l_{xx}(t+\Delta t/2)
                                    +\gamma^l_{yy}(t+\Delta t/2)
                                 \right]
                                 \Delta\lambda_l                     \nonumber\\
                          & + &2\Delta t\sum_{l=1}^N
                                 \gamma^l_{xx}(t+\Delta t/2)
                                 \Delta\mu_l          \nonumber\\ 
                          & + &\sigma_{xx}(t),                               \\
  \sigma_{yy}(t+\Delta t) & = & \Delta t\lambda_u 
                            \left [\dot{e}_{xx}(t+\Delta t/2) 
                            + \dot{e}_{yy}(t+\Delta t/2)\right]           \\
                          & + & 2\Delta t\mu_u \dot{e}_{yy}(t+\Delta t/2) 
                             +\Delta t \dot{q}_{yy}(t+\Delta t/2) \nonumber  \\
                          & + & \Delta t\sum_{l=1}^N
                                \left[\gamma^l_{xx}(t+\Delta t/2)
                                      +\gamma^l_{yy}(t+\Delta t/2)
                                \right]
                                \Delta\lambda_l                         \nonumber\\
                          & + &  2\Delta t\sum_{l=1}^N
                                \gamma_{yy}(t+\Delta t/2)
                                \Delta\mu_l \nonumber,         \\
                          & + & \sigma_{yy}(t).\\
  \sigma_{xy}(t+\Delta t) & = & 2\Delta t\mu \dot{e}_{xy}(t+\Delta t/2) 
                               + 2\Delta t \sum_{l=1}^N
                               \gamma^l_{xy}(t+\Delta t/2)\Delta\mu_l+
                               \Delta t \dot{q}_{xy}(t+\Delta t/2)\nonumber\\ 
                          & +& \sigma_{xy}(t),\nonumber\\
                          \label{eq:stress2d}
\end{eqnarray} 
The $\theta$ functions are updated as:
\begin{eqnarray*}
   \theta_{xxx}(t+\Delta t)  
                         & = &\eta^l_{1x} \theta^l_{x}(t)
                        + \eta^l_{2x}\p_x{\sigma}(t),\\
   \theta_{yyy}(t+\Delta t)  
                         & = &\eta^l_{1z} \theta^l_{x}(t)
                        + \eta^l_{2y}\p_y{\sigma}(t). \\
   \theta_{yxy}(t+\Delta t)  
                         & = &\nu^l_{1x} \theta^l_{x}(t)
                        + \nu^l_{2x}\p_x{\sigma}(t),\\
   \theta_{xyx}(t+\Delta t)  
                         & = &\nu^l_{1z} \theta^l_{x}(t)
                        + \nu^l_{2y}\p_y{\sigma}(t).
\end{eqnarray*}

The $\gamma$ functions are given by
\begin{eqnarray*}
\gamma^l_{xx}(t+3/2\Delta t)  & = &\alpha^l_{1x} \gamma^l_{xx}(t+\Delta t/2) 
                        + \alpha^l_{2x}\dot{e}_{xx}(t+\Delta t/2), \\
\gamma^l_{yy}(t+3/2\Delta t)  & = &\alpha^l_{1y} \gamma^l_{yy}(t+\Delta t/2) 
                        + \alpha^l_{2y}\dot{e}_{yy}(t+\Delta t/2).   \\
\gamma^l_{xy}(t+3/2\Delta t)  & = &\beta^l_{1y} \gamma^l_{xy}(t+\Delta t/2) 
                        + \beta^l_{2y}\dot{e}_{xy}(t+\Delta t/2). 
\end{eqnarray*}

The coefficents for the $\gamma$ and $\theta$ functions are
\begin{eqnarray*}
\alpha^l_{1x}  & = & \exp\left(-\frac{d_x(x)\Delta t}
                          {\tau^{\lambda}_{\sigma l}}\right),        \\
\alpha^l_{2x}  & = & \frac{d_x(x)\Delta t}
                  {(\tau^{\lambda}_{\sigma l}
                   \sum_{l=1}^N \frac{\tau^{\lambda}_{\epsilon l}}
                                     {\tau^{\lambda}_{\sigma l}  })
                  }                                                  \\
\alpha^l_{1y}  & = & \exp\left(-\frac{d_z(z)\Delta t}
                          {\tau^{\lambda}_{\sigma l}}\right),        \\
\alpha^l_{2y}  & = & \frac{d_z(z)\Delta t}
                  {(\tau^{\lambda}_{\sigma l}
                   \sum_{l=1}^N \frac{\tau^{\lambda}_{\epsilon l}}
                                     {\tau^{\lambda}_{\sigma l}  })
                  }                                                  \\
\beta^l_{1x}  & = & \exp\left(-\frac{d_x(x)\Delta t}
                          {\tau^{\mu}_{\sigma l}}\right),        \\
\beta^l_{2x}  & = & \frac{d_x(x)\Delta t}
                  {(\tau^{\mu}_{\sigma l}
                   \sum_{l=1}^N \frac{\tau^{\mu}_{\epsilon l}}
                                     {\tau^{\mu}_{\sigma l}  })
                  }                                                  \\
\beta^l_{1y}  & = & \exp\left(-\frac{d_y(y)\Delta t}
                          {\tau^{\mu}_{\sigma l}}\right),        \\
\beta^l_{2y}  & = & \frac{d_y(y)\Delta t}
                  {(\tau^{\mu}_{\sigma l}
                   \sum_{l=1}^N \frac{\tau^{\mu}_{\epsilon l}}
                                     {\tau^{\mu}_{\sigma l}  })
                  }                                                  \\
\eta^l_{1x}  & = & \exp\left(-\frac{d_x(x)\Delta t}
                          {\tau^{\rho}_{\sigma l}}\right),           \\
\eta^l_{2x}  & = & \frac{d_x(x)\Delta t}
                  {(\tau^{\rho}_{\sigma l}
                   \sum_{l=1}^N \frac{\tau^{\rho}_{\epsilon l}}
                                     {\tau^{\rho}_{\sigma l}  })
                  },                                                 \\
\eta^l_{1y}  & = & \exp\left(-\frac{d_z(z)\Delta t}
                          {\tau^{\rho}_{\sigma l}}\right),           \\
\eta^l_{2y}  & = & \frac{d_z(z)\Delta t}
                  {(\tau^{\rho}_{\sigma l}
                   \sum_{l=1}^N \frac{\tau^{\rho}_{\epsilon l}}
                                     {\tau^{\rho}_{\sigma l}  })
                  }.                                                 \\
\nu^l_{1x}  & = & \exp\left(-\frac{d_z(z)\Delta t}
                          {\tau^{\rho}_{\sigma l}}\right),           \\
\nu^l_{2x}  & = & \frac{d_z(z)\Delta t}
                  {(\tau^{\rho}_{\sigma l}
                   \sum_{l=1}^N \frac{\tau^{\rho}_{\epsilon l}}
                                     {\tau^{\rho}_{\sigma l}  })
                  }.                                                 \\
\nu^l_{1y}  & = & \exp\left(-\frac{d_z(z)\Delta t}
                          {\tau^{\rho}_{\sigma l}}\right),           \\
\nu^l_{2y}  & = & \frac{d_z(z)\Delta t}
                  {(\tau^{\rho}_{\sigma l}
                   \sum_{l=1}^N \frac{\tau^{\rho}_{\epsilon l}}
                                     {\tau^{\rho}_{\sigma l}  })
                  }.
\end{eqnarray*}

%-----------------------------------------------------------------------------
\subsection{The two dimensional Acoustic case}
%-----------------------------------------------------------------------------
For the acoustic 2D case we reduce the equations above by neglecting 
the y-axis terms
and putting $\mu=0$.
We consider also the pseudo-stress $\sigma$ defined by
\begin{eqnarray*}
\sigma = \frac{1}{2}\left(\sigma_{xx} + \sigma_{zz}\right) 
\end{eqnarray*}
We then get the acoustic 2D scheme as:
\begin{eqnarray*}
v_x(t+\Delta t/2) & = & \Delta t\left[\rho_{ux}^{-1}d^+_x \sigma_{xx}(t)  
                         + \rho_{ux}^{-1}f_x(t)\right] +\nonumber\\
           & + & \Delta t \sum_{l=0}^N\theta^l_{x}(t)\Delta\rho^{-1}_{x}  
                   +v_x(t-\Delta t/2),\nonumber\\
v_z(t+\Delta t/2) & = & \Delta t \left[\rho_{uz}^{-1}d^+_z \sigma_{zz}(t) 
                        + \Delta t \rho_{uz}^{-1}f_z(t)\right]\nonumber\\  
           & + & \Delta t\sum_{l=0}^N\theta^l_{z}(t)\Delta \rho^{-1}_{z}
                       +v_z(t-\Delta t/2). 
\end{eqnarray*}
The strains can now be computed from :
\begin{eqnarray*}
    \dot{e}_{xx}(t+\Delta t/2) & = & d^-_x v_x(t+\Delta t/2), \\
    \dot{e}_{zz}(t+\Delta t/2) & = & d^-_z v_z(t+\Delta t/2). 
\end{eqnarray*}
%
Equations \eqref{eq:stress}   can be solved for the stresses using 
the same approach as for the particle velocities:
\begin{eqnarray*}
  \sigma(t+\Delta t) 
       & = & \Delta t\lambda_u \left [\dot{e}_{xx}(t+\Delta t/2) 
             +\dot{e}_{zz}(t+\Delta t/2)\right]\nonumber
             +\Delta t\dot{q} \nonumber,                       \\
       & + & \Delta t\sum_{l=1}^N\gamma^l(t+\Delta t/2)\Delta\lambda_l  
                           + \sigma(t).
\end{eqnarray*} 

We now split the $\gamma^l$ into two parts $\gamma^l_x$ and $\gamma^l_z$ 
as follows:
\begin{eqnarray*}
  \sigma(t+\Delta t) & = & \Delta t\lambda_u \left [\dot{e}_{xx}(t+\Delta t/2) 
                          +\dot{e}_{zz}(t+\Delta t/2)\right]\nonumber
                           +\Delta t\dot{q} \nonumber\\
                     & + & \Delta t
                 \sum_{l=1}^N\left[\gamma^l_{x}(t+\Delta t/2)\Delta\lambda_l  
                                                   +\gamma^l_{z}(t+\Delta t/2)\Delta\lambda_l  \right]
                           + \sigma(t).\\
\end{eqnarray*} 

The $\theta$ functions are updated as:
\begin{eqnarray*}
   \theta_{x}(t+\Delta t)  
                         & = &\eta^l_{1x} \theta^l_{x}(t)
                        + \eta^l_{2x}\p_x{\sigma}(t),\\
   \theta_{z}(t+\Delta t)  
                         & = &\eta^l_{1z} \theta^l_{x}(t)
                        + \eta^l_{2z}\p_y{\sigma}(t).
\end{eqnarray*}
The $\gamma$ functions are given by
\begin{eqnarray*}
\gamma^l_x(t+3/2\Delta t)  & = &\alpha^l_{1x} \gamma^l_x(t+\Delta t/2) 
                        + \alpha^l_{2x}\dot{e}_{xx}(t+\Delta t/2), \\
\gamma^l_z(t+3/2\Delta t)  & = &\alpha^l_{1z} \gamma^l_z(t+\Delta t/2) 
                        + \alpha^l_{2z}\dot{e}_{zz}(t+\Delta t/2). 
\end{eqnarray*}

%-----------------------------------------------------------------------
\subsubsection*{Standard linear solid}
%-----------------------------------------------------------------------
The coefficents are
\begin{eqnarray*}
\alpha^l_{1x}  & = & \exp\left(-\frac{d_x(x)\Delta t}
                          {\tau^{\lambda}_{\sigma l}}\right),        \\
\alpha^l_{2x}  & = & \frac{d_x(x)\Delta t}
                  {(\tau^{\lambda}_{\sigma l}
                   \sum_{l=1}^N \frac{\tau^{\lambda}_{\epsilon l}}
                                     {\tau^{\lambda}_{\sigma l}  })
                  }                                                  \\
\alpha^l_{1z}  & = & \exp\left(-\frac{d_z(z)\Delta t}
                          {\tau^{\lambda}_{\sigma l}}\right),        \\
\alpha^l_{2z}  & = & \frac{d_z(z)\Delta t}
                  {(\tau^{\lambda}_{\sigma l}
                   \sum_{l=1}^N \frac{\tau^{\lambda}_{\epsilon l}}
                                     {\tau^{\lambda}_{\sigma l}  })
                  }                                                  \\
\eta^l_{1x}  & = & \exp\left(-\frac{d_x(x)\Delta t}
                          {\tau^{\rho}_{\sigma l}}\right),           \\
\eta^l_{2x}  & = & \frac{d_x(x)\Delta t}
                  {(\tau^{\rho}_{\sigma l}
                   \sum_{l=1}^N \frac{\tau^{\rho}_{\epsilon l}}
                                     {\tau^{\rho}_{\sigma l}  })
                  },                                                 \\
\eta^l_{1z}  & = & \exp\left(-\frac{d_z(z)\Delta t}
                          {\tau^{\rho}_{\sigma l}}\right),           \\
\eta^l_{2z}  & = & \frac{d_z(z)\Delta t}
                  {(\tau^{\rho}_{\sigma l}
                   \sum_{l=1}^N \frac{\tau^{\rho}_{\epsilon l}}
                                     {\tau^{\rho}_{\sigma l}  })
                  }.
\end{eqnarray*}
The profile functions $d_x$ and $d_z$ are
\begin{eqnarray*}
  d_x(x) = (x/L)^2,
  d_z(y) = (z/L)^2,
\end{eqnarray*}
where $L$ is the length of the absorbing layer and 
and we also have
\begin{eqnarray}
\Delta \lambda_l = \lambda_u\left(1-\frac{\tau^{\lambda}_{\epsilon l}}{\tau^{\lambda}_{\sigma l}}\right)
\Delta \rho^{-1} = \rho^{-1}_u\left(1-\frac{\tau^{\rho}_{\epsilon l}}{\tau^{\rho}_{\sigma l}}\right)
\end{eqnarray}
%-----------------------------------------------------------------------
\subsubsection*{Maxwell solid}
%-----------------------------------------------------------------------
The coefficents are
\begin{eqnarray}
  \alpha_{1x} & = & -\frac{1}{\tau^{\lambda}_0}\exp\left(-\frac{d_x(x)\Delta t}
                          {\tau^{\lambda}_0}\right),              \\
  \alpha_{2x} & = & \frac{d_x(x)\Delta t}
                  {\tau^{\lambda}_0},                             \\
  \alpha_{1z} & = & -\frac{1}{\tau^{\lambda}_0}\exp\left(-\frac{d_z(z)\Delta t}
                  {\tau^{\lambda}_0}\right),                      \\
  \alpha_{2z}  & = & \frac{d_z(z)\Delta t}
                  {\tau^{\lambda}_0}.                             \\
  \eta_{1x} & = & -\frac{1}{\tau^{\rho}_0}\exp\left(-\frac{d_x(x)\Delta t}
                          {\tau^{\rho}_0}\right),                 \\
  \eta_{2x} & = & \frac{d_x(x)\Delta t}
                  {\tau^{\rho}_0},                                \\
  \eta_{1z} & = & -\frac{1}{\tau^{\rho}_0}\exp\left(-\frac{d_z(z)\Delta t}
                  {\tau^{\rho}_0}\right),                         \\
  \eta_{2z}  & = & \frac{d_z(z)\Delta t}
                  {\tau^{\rho}_0}.                                
\end{eqnarray}
We also have
\begin{eqnarray}
  \Delta \lambda 
    & = & \lambda_u,                  \\
  \Delta \rho^{-1} 
    & = & \rho^{-1}_u.
\end{eqnarray}
%============================================================================
\section{The PyAc2d python library} 
%============================================================================
%============================================================================
\Appendix{A}{The viscoelastic standard linear solid} 
%============================================================================
Bolzman's generalization of Hook's law to the visco-elastic case is
\citep{Hudson1985}:
\begin{eqnarray}
\sigma_{ij} = \psi_{ijkl}*\dot{e}_{kl},
                  \label{eq:boltzman}
\end{eqnarray}where $\psi_{ijkl}$ is known as the relaxation tensor.
The $*$ denotes convolution defined by
\begin{eqnarray}
a(t)*b(t)=\int_0^t a(t-\tau)b(\tau).
\end{eqnarray}
Integrating \eqref{eq:boltzman} by parts
\begin{eqnarray}
\sigma_{ij}(t)=|_0^t \psi_{ijkl}(t-\tau)e_{kl}(\tau) +\int_0^t \dot{\psi}_{ijkl}(t-\tau)e_{kl}(\tau),
\end{eqnarray}
and using $e(t=0)=0$ I get
\begin{eqnarray}
\sigma_{ij}(t)=\psi(0)_{ijkl}e_{kl}(t) +\int_{0+}^t \dot{\psi}_{ijkl}(t-\tau)e_{kl}(\tau)
\end{eqnarray}
For the Zener model the components of the $\psi_{ijkl}$ tensor have the form
\begin{eqnarray}
  \psi(t)=K\left[1-\frac{1}{N}\sum_{l=1}^N 
            (1-\frac{\tau_{\epsilon l}}{\tau_{\sigma l}})\exp(-t/\tau_{\sigma l})\right]H(t).
\end{eqnarray}
%
where $K_r$ is a relaxed modulus, $N$ is the number of Zener mechanisms,$\tau_{\sigma l}$
and $\tau_{\epsilon l}$ are relaxation times. $H(t)$ is the Heavy side function.
The time derivative of $\psi$ is equal to:
\begin{eqnarray}
\dot{\psi} = \phi(t),
\end{eqnarray}
where $\phi$ is equal to:
\begin{eqnarray}
\phi(t)=
  \frac{1}{N}\sum_{l=1}^N\left[\left(\frac{K_r}{\tau_{\sigma l}}\right) 
            \left(1-\frac{\tau_{\epsilon l}}{\tau_{\sigma l}}\right)\exp(-t/\tau_{\sigma l})\right]H(t).
                \label{eq:phi}
\end{eqnarray}

Using the above we have for the stress:
\begin{eqnarray}
\sigma_{ij}(t)=c_{ijkl}e_{kl} +\int_{0+}^t \phi_{ijkl}(t-\tau)e_{kl}(\tau)
\end{eqnarray}
This is most conveniently written as
\begin{eqnarray}
\sigma_{ij}(t)=c_{ijkl}(t)*e_{kl}(t),
\end{eqnarray}
where
\begin{eqnarray}
 c_{ijkl}(t)=\psi(0)_{ijkl}\delta(t) +\phi_{ijkl}(t),
\end{eqnarray}
%
By definition $\psi(t=0)$ corresponds to the unrelaxed modulus so that we have
\begin{eqnarray}
K_u = \frac{1}{N}\sum_{l=1}^N \frac{\tau_{\epsilon l}}{\tau_{\sigma l}} K_r
\end{eqnarray}
or
\begin{eqnarray}
K_r = \frac{K_u}{\frac{1}{N}\sum_{l=1}^N \frac{\tau_{\epsilon l}}{\tau_{\sigma l}}}
\end{eqnarray}
The $\phi$ function can then be expressed in terms of the unrelaxed moduli:
\begin{eqnarray}
\phi(t) =   
  \sum_{l=1}^N\left[\left(\frac{\exp(-t/\tau_{\sigma l})}
       {\tau_{\sigma l}\sum_{l=1}^N \frac{\tau_{\epsilon l}}
       {\tau_{\sigma l}}}\right)
       K_u\left(1-\frac{\tau_{\epsilon l}}{\tau_{\sigma l}}\right)\right]
\end{eqnarray}
Finally, we express $\phi$ as:
\begin{eqnarray}
\phi(t) = \sum_{l=1}^N \phi^l(t)
\end{eqnarray}
where
\begin{eqnarray}
\phi^l(t) = 
  \left(\frac{\exp(-t/\tau_{\sigma l})}{\tau_{\sigma l}\sum_{l=1}^N 
  \frac{\tau_{\epsilon l}}{\tau_{\sigma l}}}\right)
            \Delta K_l
             \label{eq:phil}
\end{eqnarray}
and $\Delta K_l$ is
\begin{eqnarray}
\Delta K_l = K_u\left(1-\frac{\tau_{\epsilon l}}{\tau_{\sigma l}}\right)
\end{eqnarray}

It is most practical to write the time-dependent visco-elastic constants as
\begin{eqnarray}
  \lambda(t) & = & \lambda_u \delta(t) + \phi_{\lambda}(t), \\
  \mu(t)    &  =  &\mu_u\delta(t)+\phi_{\mu}(t),
\end{eqnarray}
where
%
$\phi_{\lambda}$ is given as:
\begin{eqnarray}
  \phi_{\lambda}(t) = \sum_{l=1}^N 
  \left(\frac{\exp(-t/\tau^{\lambda}_{\sigma l})}{\tau^{\lambda}_{\sigma l}\sum_{l=1}^N \frac{\tau^{\lambda}_{\epsilon l}}{\tau^{\lambda}_{\sigma l}}}\right)
            \Delta \lambda_l
\end{eqnarray}
%
and $\phi_{\mu}$ is given as:
\begin{eqnarray}
  \phi_{\mu}(t) = \sum_{l=1}^N 
  \left(\frac{\exp(-t/\tau^{\mu}_{\sigma l})}{\tau^{\mu}_{\sigma l}\sum_{l=1}^N \frac{\tau^{\mu}_{\epsilon l}}{\tau^{\mu}_{\sigma l}}}\right)
            \Delta \mu_l
\end{eqnarray}
%-----------------------------------------------------------------------------
\subsection*{Q-factors}
%-----------------------------------------------------------------------------
See \cite{Casula1992} for further relations between Q and relaxation times.
The $Q$ values are related to the Fourier transform of the $\lambda$ modulus as
\begin{eqnarray}
  Q^{-1}_{\lambda}(\omega) = \frac{Im \lambda(\omega)}{Re \lambda(\omega)}
\end{eqnarray}
Assuming $\lambda$ is given as
\begin{eqnarray}
\lambda(t) = \lambda_u\delta(t) + \phi_{\lambda}(t).
\end{eqnarray}
The fourier transform of $\lambda$ is given by

\begin{eqnarray}
\lambda(\omega) = \lambda_u + \int_{-\infty}^{\infty} \phi_{\lambda}(t) \exp(-i\omega t).
\end{eqnarray}
The Fourier transform of $\phi_\lambda$ is:

\begin{eqnarray}
\phi_{\lambda}(\omega)=  \frac{1}{N}\sum_{l=1}^N\left(\frac{\lambda_r}{\tau^{\lambda}_{\sigma l}}\right) 
            \left(1-\frac{\tau^{\lambda}_{\epsilon l}}{\tau^{\lambda}_{\sigma l}}\right)
           \int^{+\infty}_0 dt\exp(-i\omega)\exp(-t/\tau^{\lambda}_{\sigma l}).
\end{eqnarray}

The results is:
\begin{eqnarray}
\phi_{\lambda}(\omega)=  \frac{1}{N}\sum_{l=1}^N\left(\frac{\lambda_r}{\tau^{\lambda}_{\sigma l}}\right) 
            \left(1-\frac{\tau^{\lambda}_{\epsilon l}}{\tau^{\lambda}_{\sigma l}} \right)\frac{1}{1+i\omega\tau^{\lambda}_{\sigma l}}.
\end{eqnarray}

The fourier transform of $\lambda$ is then
\begin{eqnarray}
\lambda(\omega) = \lambda_u 
+\frac{1}{N}\sum_{l=1}^N\left(\frac{\lambda_r}{\tau^{\lambda}_{\sigma l}}\right) 
            \left(1-\frac{\tau^{\lambda}_{\epsilon l}}{\tau^{\lambda}_{\sigma l}} \right)\frac{1}{1+i\omega\tau^{\lambda}_{\sigma l}}.
\end{eqnarray}

After some (tedious) algebra one obtains
\begin{eqnarray}
\lambda(\omega) = \lambda_r \frac{1}{N}\sum_{l=1}^N\frac{1+i\omega\tau^{\lambda}_{\epsilon l}}{1+i\omega\tau^{\lambda}_{\sigma l}} 
\end{eqnarray}

Separating into real and imaginary parts, I get

\begin{eqnarray}
\lambda(\omega) & = & \lambda_r 
\frac{1}{N}\sum_{l=1}^N
\frac{1+\omega^2\tau^{\lambda}_{\sigma l}\tau^{\lambda}_{\epsilon l}}
     {1+(\omega\tau^{\lambda}_{\sigma l})^2}  \\\nonumber
                & + & i\lambda_r \frac{1}{N}\sum_{l=1}^N\frac{\omega\tau^{\lambda}_{\sigma l}(\tau^{\lambda}_{\epsilon}/\tau^{\lambda}_{\sigma l}-1)}
                                                              {1+(\omega\tau^{\lambda}_{\sigma l})^2}  \nonumber\\
\end{eqnarray}

We then have
\begin{eqnarray}
Q^{-1}_{\lambda} = \frac{\sum_{l=1}^N {\omega\tau^{\lambda}_{\sigma l}\left(\tau^{\lambda}_{\epsilon l}/\tau^{\lambda}_{\sigma l} -1\right)}
                                           /\left[1 + (\omega\tau^{\lambda}_{\sigma l})^2\right] 
                        }
                        {\sum_{l=1}^N (1 + \omega^2\tau^{\lambda}_{\sigma l}\tau^{\lambda}_{\epsilon l})
                                           /\left[1 + (\omega\tau^{\lambda}_{\sigma l})^2\right]       
                        }
\end{eqnarray}

The results for the frequency dependence of $\mu$ is obtained in exactly the same manner as above:
\begin{eqnarray}
\mu(\omega) = \mu_r \frac{1}{N}\sum_{l=1}^N\frac{1+i\omega\tau^{\mu}_{\epsilon l}}{1+i\omega\tau^{\mu}_{\sigma l}} 
\end{eqnarray}
 and the Q-factor for $\mu$ is
%
\begin{eqnarray}
Q^{-1}_{\mu} = \frac{\sum_{l=1}^N {\omega\tau^{\lambda}_{\sigma l}\left(\tau^{\mu}_{\epsilon l}/\tau^{\lambda}_{\sigma l} -1\right)}
                                           /\left[1 + (\omega\tau^{\mu}_{\sigma l})^2\right] 
                        }
                        {\sum_{l=1}^N (1 + \omega^2\tau^{\mu}_{\sigma l}\tau^{\mu}_{\epsilon l})
                                           /\left[1 + (\omega\tau^{\mu}_{\sigma l})^2\right]       
                        }
\end{eqnarray}
%
In practice we need to relate $Q_l$ and $Q_{\mu}$ to $Q_{\kappa}$. We use the relation
%
\begin{eqnarray}
\kappa(\omega) = \lambda(\omega)+ \frac{2}{3}\mu(\omega).
\end{eqnarray}
%
Splitting into real and imaginary parts
%
\begin{eqnarray}
\kappa_r(\omega) = \lambda_r(\omega)+ \frac{2}{3}\mu_r(\omega).
\kappa_i(\omega) = \lambda_i(\omega)+ \frac{2}{3}\mu_i(\omega).
\end{eqnarray}
%
\begin{eqnarray}
\frac{1}{Q_{\kappa}} = \frac{\kappa_i}{\kappa_r} = \frac{\lambda_i + (2/3)\mu_i}{\lambda_r + (2/3)\mu_r}
\end{eqnarray}
%
%
\begin{eqnarray}
\frac{1}{Q_{\kappa}} = \frac{\kappa_i}{\kappa_r} = \frac{\left(\frac{\lambda_i}{\lambda_r}\right)\lambda_r
                                                   + (2/3)\left(\frac{\mu_i}{\mu_r}\right)\mu_r}
                                                  {\lambda_r + (2/3)\mu_r}
\end{eqnarray}
%
%
\begin{eqnarray}
Q^{-1}_{\kappa} = \frac{Q^{-1}_\lambda \lambda_r + (2/3)Q^{-1}_{\mu}}
                                                  {\lambda_r + (2/3)\mu_r}
\end{eqnarray}
%
We can use the P-wave and S-wave velocities
%
\begin{eqnarray}
\lambda = \rho V^2_p - (2/3)\rho V^2_s \nonumber\\
\mu = \rho V^2_s
\end{eqnarray}
%
\begin{eqnarray}
Q^{-1}_{\kappa} = Q^{-1}_\lambda\left[1-\left(\frac{2}{3}\right)\left(\frac{V_s}{V_p}\right)^2\right]
                  + Q^{-1}_{\mu}\left(\frac{2}{3}\right)\left(\frac{V_s}{V_p}\right)^2
\end{eqnarray}
%
%------------------------------------------------------------------------
\subsection*{Q-model parametrization}
%-------------------------------------------------------------------------------
Q-models can be described by the two relaxation times, $\tau_{\sigma}$
and $\tau_{\epsilon}$. However it is simpler to use the two parameters
$\tau_0$ and $Q_0$ to describe a model.
According to \cite{Casula1992}, Appendix B, we have
\begin{eqnarray*}
  Q(\omega) = Q_0\frac{1+\omega^2\tau_0^2}{2\omega\tau_0}
\end{eqnarray*}
where
\begin{eqnarray*}
  Q_0 = \frac{2\tau_0}{\tau_{\epsilon} -\tau_{\sigma}}, \\
  \tau_0^2 = \tau_{\epsilon}\tau_{\sigma}.
\end{eqnarray*}
$\omega=1/\tau_0$ is the minimum value for $Q(\omega)$, i.e. the
absorption top.
We can now find $\tau_{\sigma}$ and $\tau_{\epsilon}$ in terms of
$\tau_0$ and $Q_0$ as:
\begin{eqnarray*}
  \tau_{\epsilon} = \frac{\tau_0}{Q_0}\left[\sqrt{Q^2_0+1} +1\right], \\
  \tau_{\sigma} = \frac{\tau_0}{Q_0}\left[\sqrt{Q^2_0+1} -1\right].
\end{eqnarray*}
%------------------------------------------------------------------------------
\subsection*{Effective density} 
%-------------------------------------------------------------------------------
We now assume that the effective density has the following form
\begin{eqnarray}
 \rho^{-1}_{eff}(t) = s(t).
\end{eqnarray}
We also assume that 
\begin{eqnarray}
 s(t) = s(0)\delta(t)+\chi(t)
\end{eqnarray}
So that the inverse of the effective density reads
\begin{eqnarray}
 \rho^{-1}_{eff}(t) = s_u\delta(t)+\chi(t).
\end{eqnarray}
where $s_u = s(0)=\rho^{-1}_u$.

%==============================================================================
\Appendix{B}{The Maxwell visco-elastic solid}
%===============================================================================
According to \cite{Casula1992} the Maxwell  visco-elastic solid
has a modulus given by
\begin{eqnarray}
\lambda(t) = \lambda_u\exp(-t/\tau_0)H(t)
\end{eqnarray}
In the frequency domain one gets
\begin{eqnarray}
\lambda(\omega) = \frac{\tau_0 \omega}{\omega\tau_0 -i}. 
\end{eqnarray}
or,
\begin{eqnarray}
\lambda(\omega) = \frac{\tau_0 i\omega}{i\omega\tau_0 +1}. 
\end{eqnarray}
The function $\phi$ is now:
\begin{eqnarray}
\phi(t) = -\Delta\lambda\frac{1}{\tau_0}\exp(-t/\tau_0),
\end{eqnarray}
where $\Delta\lambda = \lambda_u.$
The Q-value are related to $\tau_0$ by:
\begin{eqnarray}
  \tau_0 = Q(\omega)/\omega. 
\end{eqnarray}
A plane wave 

%==============================================================================
\Appendix{C}{Recursive computation of $\gamma$ and $s$.}
%===============================================================================
\subsection*{Standard Linear Solid}
The $\gamma$'s involve a convolution, which is difficult to compute directly.
However, a recursive relation can be found by considering
\begin{eqnarray*}
\gamma^{\lambda}_x(t+\Delta t) & = &
  \int^{t+\Delta t}_0 d\tau\,
  \frac{1}{\tau^{\lambda}_{\sigma l}
   {\sum_{l=1}^N \frac{\tau^{\lambda}_{\epsilon l}}
   {\tau^{\lambda}_{\sigma l}}} }
  \exp(-\frac{t+\Delta t -\tau}{\tau^{\lambda}_{\sigma}})
  \dot{e}_{xx}(\tau).
\end{eqnarray*}
\begin{eqnarray*}
\gamma^{\lambda}_x(t+\Delta t) & = &
  \frac{1}{\tau^{\lambda}_{\sigma l}{\sum_{l=1}^N \frac{\tau^{\lambda}_{\epsilon l}}{\tau^{\lambda}_{\sigma l}}} }
  \exp(-\frac{\Delta t}{\tau^{\lambda}_{\sigma}})
  \int^{t+\Delta t}_{0} d\tau\,
  \exp(-\frac{t-\tau}{\tau^{\lambda}_{\sigma}})
  \dot{e}_{xx}(\tau).
\end{eqnarray*}
\begin{eqnarray*}
\gamma^{\lambda}_x(t+\Delta t) 
 & = & 
  \frac{1}{\tau^{\lambda}_{\sigma l}\sum_{l=1}^N \frac{\tau^{\rho}_{\epsilon l}}{\tau^{\rho}_{\sigma l}}}
  \exp(-\frac{\Delta t}{\tau^{\lambda}_{\sigma}})
  \int^{t}_0 d\tau\,
  \exp(-\frac{t-\tau}{\tau^{\lambda}_{\sigma}})
  \dot{e}_{xx}(\tau)\\
 & + &
  \frac{1}{\tau^{\lambda}_{\sigma l}\sum_{l=1}^N \frac{\tau^{\rho}_{\epsilon l}}{\tau^{\rho}_{\sigma l}}}
  %\frac{1}{\sum_{l=1}^N \frac{\tau^{\rho}_{\epsilon l}}{\tau^{\rho}_{\sigma l}}}
  \exp(-\frac{\Delta t}{\tau^{\lambda}_{\sigma}})
  \int^{t+\Delta t}_t d\tau\,
  \exp(-\frac{t-\tau}{\tau^{\lambda}_{\sigma}})
  \dot{e}_{xx}(\tau).
\end{eqnarray*}
The second intergral is approximated by
 assuming that $\dot{e}_{xx}(t)$ is constant in the interval $t$ to $t+\Delta t$
\begin{eqnarray*}
\gamma^{\lambda}_x(t+\Delta t) 
 & = & %\frac{1}{\tau_{\epsilon}} 
  \frac{1}{\tau^{\lambda}_{\sigma l}\sum_{l=1}^N \frac{\tau^{\rho}_{\epsilon l}}{\tau^{\rho}_{\sigma l}}}
\exp(-\frac{\Delta t}{\tau^{\lambda}_{\sigma}})
       \int^{t}_0 d\tau\,
       \exp(-\frac{t-\tau}{\tau^{\lambda}_{\sigma}})
       \dot{e}_{xx}(\tau)\\
 & + &
       \frac{1}{\tau_{\epsilon}} \exp(-\frac{\Delta t}{\tau^{\lambda}_{\sigma}})
       \dot{e}_{xx}(t)\int^{t+\Delta t}_t d\tau\,
       \exp(-\frac{t-\tau}{\tau^{\lambda}_{\sigma}})
\end{eqnarray*}
Performing the integral we then get
\begin{eqnarray*}
\gamma^{\lambda}_x(t+\Delta t) 
   & = & \gamma^{\lambda}_x (t)\exp(-\frac{\Delta t}{\tau^{\lambda}_{\sigma}}) \\
   & + & \frac{\tau_{\sigma}}{\tau_{\epsilon}}
         \left[1-\exp(-\frac{\Delta t}{\tau^{\lambda}_{\sigma}})\right]
         \dot{e}_{xx}(t).
\end{eqnarray*}
%
For small $\Delta t \ll 1$ the last equation is also
\begin{eqnarray*}
\gamma^{\lambda}_x(t+\Delta t) 
   & = & \gamma^{\lambda}_x (t)\exp(-\frac{\Delta t}{\tau^{\lambda}_{\sigma}}) \\
   & + & \frac{\Delta t}{\tau_{\epsilon}}\dot{e}_{xx}(t).
\end{eqnarray*}
%------------------------------------------
\subsection*{Maxwell solid}
%------------------------------------------
The $\gamma$'s involve a convolution, which is difficult to compute directly.
However, a recursive relation can be found by considering
\begin{eqnarray*}
\gamma^{\lambda}_x(t+\Delta t) & = &
  -\int^{t+\Delta t}_0 d\tau\,
  \frac{1}{\tau^{\lambda}_0}
  \exp(-\frac{t+\Delta t -\tau}{\tau^{\lambda}_0})
  \dot{e}_{xx}(\tau).
\end{eqnarray*}
\begin{eqnarray*}
\gamma^{\lambda}_x(t+\Delta t) & = &
  -\frac{1}{\tau^{\lambda}_{0}}
  \exp(-\frac{\Delta t}{\tau^{\lambda}_{0}})
  \int^{t+\Delta t}_{0} d\tau\,
  \exp(-\frac{t-\tau}{\tau^{\lambda}_{0}})
  \dot{e}_{xx}(\tau).
\end{eqnarray*}
\begin{eqnarray*}
\gamma^{\lambda}_x(t+\Delta t) 
 & = & 
  -\frac{1}{\tau^{\lambda}_0}
  \exp(-\frac{\Delta t}{\tau^{\lambda}_{0}})
  \int^{t}_0 d\tau\,
  \exp(-\frac{t-\tau}{\tau^{\lambda}_{0}})
  \dot{e}_{xx}(\tau)\\
 & - &
  \frac{1}{\tau^{\lambda}_{0}}
  \exp(-\frac{\Delta t}{\tau^{\lambda}_{0}})
  \int^{t+\Delta t}_t d\tau\,
  \exp(-\frac{t-\tau}{\tau^{\lambda}_{0}})
  \dot{e}_{xx}(\tau).
\end{eqnarray*}
The second intergral is approximated by
 assuming that $\dot{e}_{xx}(t)$ is constant in the interval $t$ to $t+\Delta t$
\begin{eqnarray*}
\gamma^{\lambda}_x(t+\Delta t) 
 & = & 
  -\frac{1}{\tau^{\lambda}_{0}}
\exp(-\frac{\Delta t}{\tau^{\lambda}_{0}})
       \int^{t}_0 d\tau\,
       \exp(-\frac{t-\tau}{\tau^{\lambda}_{0}})
       \dot{e}_{xx}(\tau)\\
 & - &
       \frac{1}{\tau^{\lambda}_{0}} \exp(-\frac{\Delta t}{\tau^{\lambda}_{0}})
       \dot{e}_{xx}(t)\int^{t+\Delta t}_t d\tau\,
       \exp(-\frac{t-\tau}{\tau^{\lambda}_{0}})
\end{eqnarray*}
Performing the integral we then get
\begin{eqnarray*}
\gamma^{\lambda}_x(t+\Delta t) 
   & = & \gamma^{\lambda}_x (t)\exp(-\frac{\Delta t}{\tau^{\lambda}_{\sigma}}) \\
   & + & 
         \left[1-\exp(-\frac{\Delta t}{\tau^{\lambda}_{0}})\right]
         \dot{e}_{xx}(t).
\end{eqnarray*}
%
For small $\Delta t \ll 1$ the last equation is also
\begin{eqnarray*}
\gamma^{\lambda}_x(t+\Delta t) 
   & = & \gamma^{\lambda}_x (t)\exp(-\frac{\Delta t}{\tau^{\lambda}_{\sigma}}) \\
   & + & \frac{\Delta t}{\tau_{0}}\dot{e}_{xx}(t).
\end{eqnarray*}
%==============================================================================
\Appendix{E}{Comparison with CPML}
%==============================================================================
\cite{Komatitsch2007} show that the implementation of the CPML method can
be performed by replacing each spatial derivative with
(Their's equation (16) and (18)):
\begin{eqnarray}
  s_x = \delta(t) - d_x H(t) \exp \left[-(d_x+\alpha_x)t\right].
                                          \label{eq:A-Komatitsch} 
\end{eqnarray}
We compare this with our equation
\begin{eqnarray}
  \lambda(t)/\lambda_u = \delta(t) + \frac{1}{\tau_{\epsilon}}
                         \exp(-t /\tau_{\sigma}) H(t)
                         \left(1-\frac{\tau_{\epsilon}}{\tau_{\sigma}}\right)
                                           \label{eq:A-lambda}
\end{eqnarray}
Comparing equation \eqref{eq:A-Komatitsch} with equation
\eqref{eq:A-lambda} one gets:
\begin{eqnarray}
-d_x         & = & \frac{1}{\tau_{\epsilon}}\left(1-\frac{\tau_{\epsilon}}
                                            {\tau_{\sigma}}\right), \\
d_x +\alpha & = & \frac{1}{\tau_{\sigma}}
\end{eqnarray}
Solving for $\tau_{\epsilon}$ and $\tau_{\sigma}$ one gets
\begin{eqnarray}
  \tau_{\sigma}   & = & \frac{1}{(d_x+\alpha)},\\
  \tau_{\epsilon} & = & \frac{1}{\alpha}.
\end{eqnarray}.
Here 
\begin{eqnarray}
 d_x (x) & = & d_0 \left(\frac{1-x}{L}\right)^2, \\
 \alpha(x) & = & f_0\left[1-\left(\frac{x}{L}\right)\right].
\end{eqnarray}
where $d_0$ and $e_0$ are constants and $L$ is the length of
the PML zone and $x$ is the distance from the start (outer border of model)
of the PML zone.

%============================================================================
\bibliographystyle{seg}  % style file is seg.bst
\bibliography{references}
%==============================================================================
\end{document}
%==============================================================================
\Appendix{F}{Target independent GPU code} 
%===============================================================================
The availablity of GPU's is an opportunity for Scientists to accelerate
computations on desktop PC's and HPC clusters significantly. This has been
a real blessing and made me, at least, happy and more productive.
However, there is a drawback; For the average scientist it is 
relatively cumbersome and difficult to write code for GPU's using vendor
specific languages such as CUDA or hip.
In many cases this can be avoided either by using libraries callable from
python or C/C++.  But in many cases excisting libraries are either akward or impossible to use and you have to write your own. 
In these cases I really want a simple standard programming language capable of offloading
computations directly to any GPU without the need for knowing the details of
how this is done. The exact same source code should be compilable to many different GPU's.

Such languages exists, NVIDIA offers Fortran and C/C++ with offloading to
GPU simple by setting an option. No changes to the code are needed. Also Numba is a language capable of
compiling to GPU. However, only NVIDIA GPU's are supported. The Julia programming
language is capable of supporting several GPU architectures, but the source code
is different for different GPU's. And Julia is difficult to interface with f.ex. Python.

So my prefered solution for programming gpu's does not exist. The obvious question then is:
How difficult can it be to make a compiler capable of generating code for NVIDIA, AMD or Apple GPU
from the exact same source code? To figure out the answer I decided to actually make a tool
capable of offloading computations to many different GPU architecture using the same
input source code. 

The first difficulty in doing this is the programming language itself.
Numerous authors have for a long time tried to automatically compile code written in traditional 
languages to effective GPU code. The results have not been good. Although recently there have been
progress using AI tools for this purpose. This might be the solution.   
On the other hand have scientist for a very long time used language constructs which can
be very effectively translated to GPU code. The simplest example is the Fortan DOCONCURRENT
loop construction, which looks like a traditional for-loop  but with the understanding
that the computation inside the body of the loop can be run in parallel. 
The simplest approach is then a very limited programming language, and since I like C, with
C-like syntax.

The main difference between traditional C and this new language is
the parallel construct:
\begin{verbatim}
  parallel(i=1,N){
    a[i] = b[i] + c[i];
  }
\end{verbatim}
Which looks like a for-loop but signifies that the
computations are to be performed in parallel.
This construct is easy to map to GPU architectures.

Implementing all of C in addition to the parallel statement is out
of the question, instead a very slimmed down version of C is used.
The only significant difference with C is the use of proper multi-dimensional arrays.
The arrays are dynamic and contains size-information.
Instead of pointers, references is used and a new keyword for
memory allocation is introduced.
Structures are allowed, but are dynamic and behave more like simple classes than C-like structs.

This limited language is easy to implement in a simple compiler. 
Instead of generating machine code, the output
from the compiler is CUDA, hip or Metal Shading code.

The performance of the generated GPU code is almost as good as handwritten code,
as the examples in this manual shows.

The answer to the questions above is that it is not difficult at
all to write a small compiler capable of generating GPU code for
many different architectures. At least not for the kinds of problems (seismic wave propagation)
I am dealing with.
\end{document}      

